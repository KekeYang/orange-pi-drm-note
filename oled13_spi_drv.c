#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/fs.h>
#include <linux/cdev.h>
#include <linux/device.h>
#include <linux/sysfs.h>
#include <linux/kobject.h>
#include <linux/string.h>
#include <linux/platform_device.h>
#include <linux/kmod.h>
#include <linux/timer.h>
#include <asm/uaccess.h>
#include <asm/io.h>
#include <linux/delay.h>

/*
	000: input
	001: output

	PA6 :OLED_CS
		select:	0x01c20800+0x00 [24:26]
		data	0x01c20800+0x10 [6]
	PA7 :OLED_DC
		select:	0x01c20800+0x00 [28:30]
		data	0x01c20800+0x10 [7]
===========================================
	PA8 :OLED_RST
		select:	0x01c20800+0x04 [0:2]
		data	0x01c20800+0x10 [8]
	PA9 :OLED_MOSI
		select:	0x01c20800+0x04 [4:6]
		data	0x01c20800+0x10 [9]
	PA10 :OLED_CLK
		select:	0x01c20800+0x04 [8:10]
		data	0x01c20800+0x10 [10]	
*/


MODULE_LICENSE("GPL");

#define p_pa6_func (0x01c20800)
#define p_pa8_func (0x01c20804)
#define p_pa6_data (0x01c20810)
#define p_pa6_drv  (0x01c20814)
#define p_pa6_pull (0x01c2081c)



volatile unsigned int *v_pa6_func = NULL;
volatile unsigned int *v_pa8_func = NULL;
volatile unsigned int *v_pa6_data = NULL;
volatile unsigned int *v_pa6_drv  = NULL;
volatile unsigned int *v_pa6_pull = NULL;


void OLED_CS(unsigned char value)
{
	if(value) {
		*v_pa6_data &= ~(1 << 6);
	}
	else {
		*v_pa6_data |= (1 << 6);
	}
}

void OLED_DC(unsigned char value)
{
	if(value) {
		*v_pa6_data &= ~(1 << 7);
	}
	else {
		*v_pa6_data |= (1 << 7);
	}
}


void OLED_RST(unsigned char value)
{
	if(value) {
		*v_pa6_data &= ~(1 << 8);
	}
	else {
		*v_pa6_data |= (1 << 8);
	}
}

void OLED_MOSI(unsigned char value)
{
	if(value) {
		*v_pa6_data &= ~(1 << 9);
	}
	else {
		*v_pa6_data |= (1 << 9);
	}
}

void OLED_CLK(unsigned char value)
{
	if(value) {
		*v_pa6_data &= ~(1 << 10);
	}
	else {
		*v_pa6_data |= (1 << 10);
	}
}

/* --------------------------------------------------------------- */


/**********SPI引脚分配，连接oled屏，更具实际情况修改*********/

// #define SPI_SCK_0  OLED_CLK(0) 
// #define SPI_SCK_1  OLED_CLK(1) 
// #define SPI_SDA_0  OLED_MOSI(0) 
// #define SPI_SDA_1  OLED_MOSI(1)
// #define SPI_RST_0  OLED_RST(0) 
// #define SPI_RST_1  OLED_RST(1)
// #define SPI_DC_0   OLED_DC(0) 
// #define SPI_DC_1   OLED_DC(1)
// #define SPI_CS_0   OLED_CS(0)    
// #define SPI_CS_1   OLED_CS(1)

/*
sbit SCL=P1^0;//serial clock input
sbit SI= P1^1;//serial data input
sbit RES=P1^2;
sbit RS= P1^3;
sbit _CS=P1^4;
*/

#define _nop_() udelay(1)

unsigned char picture_tab[]={
//--  ???????:C:\Users\Administrator\Desktop\11.bmp  "gycLOGO..."
//--  ??x??=128x64  --//
//0x80,0x40,0x10,//?????,?????,?????,??????
0xFF,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0xFF,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x20,0x44,0x08,0x00,0x18,0x48,0x28,0xC8,0x08,0x28,0x48,0x18,0x00,
0x40,0x40,0xFC,0x40,0x40,0xFC,0x00,0x00,0xF8,0x00,0x00,0xFC,0x00,0x40,0x40,0xA0,
0x90,0x88,0x84,0x88,0x90,0x20,0x40,0x40,0x00,0x00,0x40,0x44,0xD8,0x20,0xF0,0xAC,
0xA8,0xE8,0xB8,0xA8,0xE0,0x00,0x00,0x00,0xC0,0x7C,0x54,0x54,0x54,0x54,0x54,0x54,
0x7C,0x40,0x40,0x00,0x00,0xF0,0x90,0x90,0x90,0xFC,0x90,0x90,0x90,0xF0,0x00,0x00,
0x00,0x80,0x88,0x88,0x88,0x88,0x88,0xE8,0xA8,0x98,0x8C,0x88,0x80,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x04,0x3E,0x01,0x10,0x11,0x09,0x05,0x3F,0x05,0x09,0x11,0x11,0x00,
0x08,0x18,0x0F,0x24,0x14,0x0F,0x00,0x00,0x0F,0x00,0x00,0x3F,0x00,0x20,0x22,0x2A,
0x32,0x22,0x3F,0x22,0x32,0x2A,0x22,0x20,0x00,0x00,0x20,0x10,0x0F,0x10,0x28,0x24,
0x23,0x20,0x2F,0x28,0x2A,0x2C,0x00,0x30,0x0F,0x04,0x3D,0x25,0x15,0x15,0x0D,0x15,
0x2D,0x24,0x24,0x00,0x00,0x07,0x04,0x04,0x04,0x1F,0x24,0x24,0x24,0x27,0x20,0x38,
0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0xFF,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0xFF,
0xFF,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x81,0x41,0x21,0x21,0x61,0x01,0x01,0x21,0xE1,0xE1,0x01,0xE1,0xE1,
0x21,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x21,0xE1,0x21,0x21,0x21,0x61,0x01,0x01,
0x21,0x21,0xE1,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0xC1,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x21,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0xFF,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x0F,0x10,0x20,0x24,0x1C,0x04,0x00,0x20,0x3F,0x01,0x3E,0x01,0x3F,
0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x22,0x22,0x27,0x30,0x00,0x00,
0x20,0x20,0x3F,0x20,0x20,0x00,0x00,0x1E,0x25,0x25,0x25,0x16,0x00,0x00,0x1E,0x21,
0x21,0x21,0x13,0x00,0x01,0x01,0x1F,0x21,0x21,0x00,0x00,0x00,0x21,0x3F,0x22,0x21,
0x01,0x00,0x00,0x1E,0x21,0x21,0x21,0x1E,0x00,0x21,0x3F,0x22,0x01,0x01,0x3E,0x20,
0x00,0x21,0x21,0x3F,0x20,0x20,0x00,0x00,0x1E,0x21,0x21,0x21,0x13,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xF0,0x08,0x04,0x04,0x04,0x0C,0x00,0xF0,0x08,0x04,0x04,0x08,0xF0,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0xFC,0x04,0x00,
0x00,0x00,0x00,0x00,0x0C,0x04,0xFC,0x04,0x0C,0x00,0x04,0xFC,0x04,0x04,0x08,0xF0,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0xFF,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x81,0x82,0x84,0x84,0x84,0x82,0x80,0x81,0x82,0x84,0x84,0x82,0x81,
0x80,0x80,0x86,0x86,0x80,0x80,0x80,0x80,0x80,0x85,0x83,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x84,0x87,0x84,0x84,
0x84,0x86,0x80,0x80,0x80,0x84,0x87,0x84,0x80,0x80,0x84,0x87,0x84,0x84,0x82,0x81,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0xFF,
};

void Ins_trans(unsigned char command)
{
	unsigned char counter;
	OLED_CS(0);
	OLED_DC(0);
	for(counter=0;counter<8;counter++)
	{
		OLED_CLK(0);
		OLED_MOSI((command&0x80)>>7);
		command=command<<1;
		_nop_();
		OLED_CLK(1);
		//  _nop_();
		_nop_();
		OLED_CLK(0);
	}
	OLED_DC(1);
	OLED_CS(1);
}
void Data_trans(unsigned char command)
{
	unsigned char counter;
	OLED_CS(0);
	OLED_DC(1);
	for(counter=0;counter<8;counter++)
	{
		OLED_CLK(0);
		OLED_MOSI((command&0x80)>>7);
		command=command<<1;
		_nop_();
		OLED_CLK(1);
		// _nop_();
		_nop_();
		OLED_CLK(0);
	}
	OLED_DC(1);
	OLED_CS(1);
}
void Column_set(unsigned char column)
{
	Ins_trans(0x10|(column>>4));
	Ins_trans(0x00|(column&0x0f));
}
void Page_set(unsigned char page)
{
	Ins_trans(0xb0+page);
}
void Screen_FillClear(unsigned char FC)
{
 unsigned char page,column;
  for(page=0;page<8;page++)             //page loop
	 {
	   Page_set(page);
	   Column_set(2);
	   for(column=0;column<128;column++)	//column loop
		  {
			 Data_trans(FC);
			}
	   }
 }

void Picture_display(unsigned char *ptr_pic)
{
  unsigned char page,column;
  for(page=0;page<(64/8);page++)        //page loop
	 {
	   Page_set(page);
	   Column_set(2);
	   for(column=0;column<128;column++)	//column loop
		  {
			 Data_trans(*ptr_pic++);
		  }
	 }
  mdelay(15);
}

void Initial(void)
{
	Ins_trans(0xAE);//--turn off oled panel

	Ins_trans(0x02);//--set low column address
	Ins_trans(0x10);//--set high column address

	Ins_trans(0x40);//--set start line address

	Ins_trans(0xB0);//--set page address

	Ins_trans(0x81);//--set contrast control register
	Ins_trans(0xFF);

	Ins_trans(0xA1);//--set segment re-map 127 to 0   a0:0 to seg127
	Ins_trans(0xA4);//--set normal display
	Ins_trans(0xA6);//--set indication display
	Ins_trans(0xC8);//--set com(N-1)to com0  c0:com0 to com(N-1)

	Ins_trans(0xA8);//--set multiples ratio(1to64)
	Ins_trans(0x3F);//--1/64 duty

	Ins_trans(0xD5);//--set display clock divide ratio/oscillator frequency
	Ins_trans(0x80);//--set divide ratio

	Ins_trans(0xD3);//--set display offset
	Ins_trans(0x00);//--not offset

	Ins_trans(0xAD);//--DC-DC ON/OFF Mode Set
	Ins_trans(0x8B);//--8A:DC-DC is disable,8B:DC-DC will be turned on when display on.(POR)

	Ins_trans(0xDA);//--set com pins hardware configuration
	Ins_trans(0x12);

	Ins_trans(0xDB);//--set vcomh
	Ins_trans(0x40);

	Ins_trans(0xD9);//--set charge period
	Ins_trans(0xF1);

	Ins_trans(0xAF);//--turn on oled panel
}

/* --------------------------------------------------------------- */
struct test_platform_data
{
	int idx;
};
static struct test_platform_data test_info = {
	.idx = 25,
};

static void plate_test_release(struct device *dev)
{
	return;
}


static struct platform_device plate_test_device = {
	.name	= "platetest",
	.id		= -1,
	.dev	= {
		.platform_data = &test_info,
		.release	= plate_test_release,
	},
};


static int plate_test_probe(struct platform_device *pdev)
{
	printk(KERN_ERR "[%s][%d]\n", __func__, __LINE__);


	v_pa6_func = (volatile unsigned int *)ioremap(p_pa6_func, 64);
	v_pa8_func = (volatile unsigned int *)(v_pa6_func + ((p_pa8_func - p_pa6_func)/4));
	v_pa6_data = (volatile unsigned int *)(v_pa6_func + ((p_pa6_data - p_pa6_func)/4));
	v_pa6_drv  = (volatile unsigned int *)(v_pa6_func + ((p_pa6_drv  - p_pa6_func)/4));
	v_pa6_pull = (volatile unsigned int *)(v_pa6_func + ((p_pa6_pull - p_pa6_func)/4));



	printk(KERN_ERR "[%s][%d][v_pa6_func = 0x%x]\n", __func__, __LINE__, v_pa6_func);
	printk(KERN_ERR "[%s][%d][v_pa8_func = 0x%x]\n", __func__, __LINE__, v_pa8_func);
	printk(KERN_ERR "[%s][%d][v_pa6_data = 0x%x]\n", __func__, __LINE__, v_pa6_data);

	// set func output
	*v_pa6_func &= ~((7 << 24) | (7 << 28));
	*v_pa6_func |=  ((1 << 24) | (1 << 28));

	*v_pa8_func &= ~((7 << 0) | (7 << 4) | (7 << 8));
	*v_pa8_func |=  ((1 << 0) | (1 << 4) | (1 << 8));

	// set drv
	*v_pa6_drv  &= ~((3 << (2*6)) | (3 << (2*7)) | (3 << (2*8)) | (3 << (2*9)) | (3 << (2*10)));
	*v_pa6_drv  |=  ((3 << (2*6)) | (3 << (2*7)) | (3 << (2*8)) | (3 << (2*9)) | (3 << (2*10)));
	
	// set pull
	*v_pa6_pull &= ~((3 << (2*6)) | (3 << (2*7)) | (3 << (2*8)) | (3 << (2*9)) | (3 << (2*10)));
	*v_pa6_pull |=  ((0 << (2*6)) | (0 << (2*7)) | (0 << (2*8)) | (0 << (2*9)) | (0 << (2*10)));

	printk(KERN_ERR "[%s][%d][*v_pa6_func = 0x%x]\n", __func__, __LINE__, *v_pa6_func);
	printk(KERN_ERR "[%s][%d][*v_pa8_func = 0x%x]\n", __func__, __LINE__, *v_pa8_func);
	printk(KERN_ERR "[%s][%d][*v_pa6_data = 0x%x]\n", __func__, __LINE__, *v_pa6_data);


	/*-------------------------------*/

	OLED_RST(0);
	
	printk(KERN_ERR "[%s][%d][*v_pa6_data = 0x%x]\n", __func__, __LINE__, *v_pa6_data);
	mdelay(10);
	OLED_RST(1);
	
	printk(KERN_ERR "[%s][%d][*v_pa6_data = 0x%x]\n", __func__, __LINE__, *v_pa6_data);
	Initial();

	Screen_FillClear(0x00);
	Picture_display(picture_tab);
	Screen_FillClear(0xFF);
	mdelay(05);


	return 0;
}


static int plate_test_remove(struct platform_device *pdev)
{
	printk(KERN_ERR "[%s][%d]\n", __func__, __LINE__);

	iounmap(v_pa6_func);

	return 0;
}

static int plate_test_resume_p(struct device *pdev)
{
	return 0;
}

static int plate_test_suspend_p(struct device *pdev)
{
	return 0;
}


static const struct dev_pm_ops plate_test_pm_ops = {
	.resume_early = plate_test_resume_p,
	.suspend_late = plate_test_suspend_p,	
};


static struct platform_driver plate_test_driver = {
	.probe = plate_test_probe,
	.remove = plate_test_remove,

	.driver = {
			.name = "platetest",
			.owner = THIS_MODULE,
			.pm = &plate_test_pm_ops,
	},
};

static int __init plateform_test_init(void)
{
	platform_device_register(&plate_test_device);
	platform_driver_register(&plate_test_driver);
	return 0;
}


static void __exit plateform_test_exit(void)
{
	platform_driver_unregister(&plate_test_driver);
	platform_device_unregister(&plate_test_device);
}


module_init(plateform_test_init);
module_exit(plateform_test_exit);

