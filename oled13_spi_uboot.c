#include <common.h>
#include <bootm.h>
#include <command.h>
#include <env.h>
#include <errno.h>
#include <image.h>
#include <malloc.h>
#include <nand.h>
#include <asm/byteorder.h>
#include <linux/ctype.h>
#include <linux/err.h>
#include <u-boot/zlib.h>
#include <mapmem.h>
#include <asm/arch/clock.h>
#include <asm/arch/display.h>
#include <asm/arch/gpio.h>
#include <asm/arch/lcdc.h>
#include <asm/arch/pwm.h>
#include <asm/arch/tve.h>
#include <asm/global_data.h>
#include <asm/gpio.h>
#include <asm/io.h>
#include <linux/delay.h>


#define p_pa6_func (0x01c20800)
#define p_pa8_func (0x01c20804)
#define p_pa6_data (0x01c20810)
#define p_pa6_drv  (0x01c20814)
#define p_pa6_pull (0x01c2081c)

volatile unsigned int *v_pa6_func = (volatile unsigned int *)p_pa6_func;
volatile unsigned int *v_pa8_func = (volatile unsigned int *)p_pa8_func;
volatile unsigned int *v_pa6_data = (volatile unsigned int *)p_pa6_data;
volatile unsigned int *v_pa6_drv  = (volatile unsigned int *)p_pa6_drv;
volatile unsigned int *v_pa6_pull = (volatile unsigned int *)p_pa6_pull;

static int inited = 1;

void OLED_CS(unsigned char value)
{
	if(!value) {
		*v_pa6_data &= ~(1 << 6);
	}
	else {
		*v_pa6_data |= (1 << 6);
	}
}

void OLED_DC(unsigned char value)
{
	if(!value) {
		*v_pa6_data &= ~(1 << 7);
	}
	else {
		*v_pa6_data |= (1 << 7);
	}
}


void OLED_RST(unsigned char value)
{
	if(!value) {
		*v_pa6_data &= ~(1 << 8);
	}
	else {
		*v_pa6_data |= (1 << 8);
	}
}

void OLED_MOSI(unsigned char value)
{
	if(!value) {
		*v_pa6_data &= ~(1 << 9);
	}
	else {
		*v_pa6_data |= (1 << 9);
	}
}

void OLED_CLK(unsigned char value)
{
	if(!value) {
		*v_pa6_data &= ~(1 << 10);
	}
	else {
		*v_pa6_data |= (1 << 10);
	}
}


// #define SPI_SCK_0  OLED_CLK(0) 
// #define SPI_SCK_1  OLED_CLK(1) 
// #define SPI_SDA_0  OLED_MOSI(0) 
// #define SPI_SDA_1  OLED_MOSI(1)
// #define SPI_RST_0  OLED_RST(0) 
// #define SPI_RST_1  OLED_RST(1)
// #define SPI_DC_0   OLED_DC(0) 
// #define SPI_DC_1   OLED_DC(1)
// #define SPI_CS_0   OLED_CS(0)    
// #define SPI_CS_1   OLED_CS(1)

#define OLED_COLUMN_NUMBER 128
#define OLED_LINE_NUMBER 64
#define OLED_COLUMN_OFFSET 2
#define OLED_PAGE_NUMBER OLED_LINE_NUMBER/8

/**********SPI引脚分配，连接oled屏，更具实际情况修改*********/

#define SPI_SCK_0  OLED_CLK(0) 
#define SPI_SCK_1  OLED_CLK(1) 
#define SPI_SDA_0  OLED_MOSI(0) 
#define SPI_SDA_1  OLED_MOSI(1)
#define SPI_RST_0  OLED_RST(0) 
#define SPI_RST_1  OLED_RST(1)
#define SPI_DC_0   OLED_DC(0) 
#define SPI_DC_1   OLED_DC(1)
#define SPI_CS_0   OLED_CS(0)    
#define SPI_CS_1   OLED_CS(1)




const unsigned char  OLED_init_cmd[25]=			//SH1106
{
  
  /*0xae,0X00,0X10,0x40,0X81,0XCF,0xff,0xa1,0xa4,
  0xA6,0xc8,0xa8,0x3F,0xd5,0x80,0xd3,0x00,0XDA,0X12,
  0x8d,0x14,0xdb,0x40,0X20,0X02,0xd9,0xf1,0xAF*/
       0xAE,//关闭显示
	
       0xD5,//设置时钟分频因子,震荡频率
       0x80,  //[3:0],分频因子;[7:4],震荡频率

       0xA8,//设置驱动路数
       0X3F,//默认(1/64)
	
       0xD3,//设置显示偏移
       0X00,//默认为0
	
       0x40,//设置显示开始行 [5:0],行数.
	
       0x8D,//电荷泵设置
       0x14,//bit2，开启/关闭
       0x20,//设置内存地址模式
       0x02,//[1:0],00，列地址模式;01，行地址模式;10,页地址模式;默认10;
       0xA1,//段重定义设置,bit0:0,0->0;1,0->127;  A1
	
       0xC8,//设置COM扫描方向;bit3:0,普通模式;1,重定义模式 COM[N-1]->COM0;N:驱动路数 (C0 翻转显示) C8
	   
       0xDA,//设置COM硬件引脚配置
       0x12,//[5:4]配置  
	   
       0x81,//对比度设置
       0x66,//1~255;默认0X7F (亮度设置,越大越亮)
	   
       0xD9,//设置预充电周期
       0xf1,//[3:0],PHASE 1;[7:4],PHASE 2;
	   
       0xDB,//设置VCOMH 电压倍率
       0x30,//[6:4] 000,0.65*vcc;001,0.77*vcc;011,0.83*vcc;
	   
       0xA4,//全局显示开启;bit0:1,开启;0,关闭;(白屏/黑屏)
	   
       0xA6,//设置显示方式;bit0:1,反相显示;0,正常显示 
       
       0xAF,//开启显示     
};


const unsigned char  picture_tab[]={
/*------------------------------------------------------------------------------
;  源文件 / 文字 : C:\Documents and Settings\Administrator\桌面\新建文件夹 (2)\logo.bmp字模
;  宽×高（像素）: 128×64
------------------------------------------------------------------------------*/
//0x80,0x40,0x10,//宽的像素数,高的像素数，宽的字节数，参数设置可选
0xFF,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0xFF,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x20,0x44,0x08,0x00,0x18,0x48,0x28,0xC8,0x08,0x28,0x48,0x18,0x00,
0x40,0x40,0xFC,0x40,0x40,0xFC,0x00,0x00,0xF8,0x00,0x00,0xFC,0x00,0x40,0x40,0xA0,
0x90,0x88,0x84,0x88,0x90,0x20,0x40,0x40,0x00,0x00,0x40,0x44,0xD8,0x20,0xF0,0xAC,
0xA8,0xE8,0xB8,0xA8,0xE0,0x00,0x00,0x00,0xC0,0x7C,0x54,0x54,0x54,0x54,0x54,0x54,
0x7C,0x40,0x40,0x00,0x00,0xF0,0x90,0x90,0x90,0xFC,0x90,0x90,0x90,0xF0,0x00,0x00,
0x00,0x80,0x88,0x88,0x88,0x88,0x88,0xE8,0xA8,0x98,0x8C,0x88,0x80,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x04,0x3E,0x01,0x10,0x11,0x09,0x05,0x3F,0x05,0x09,0x11,0x11,0x00,
0x08,0x18,0x0F,0x24,0x14,0x0F,0x00,0x00,0x0F,0x00,0x00,0x3F,0x00,0x20,0x22,0x2A,
0x32,0x22,0x3F,0x22,0x32,0x2A,0x22,0x20,0x00,0x00,0x20,0x10,0x0F,0x10,0x28,0x24,
0x23,0x20,0x2F,0x28,0x2A,0x2C,0x00,0x30,0x0F,0x04,0x3D,0x25,0x15,0x15,0x0D,0x15,
0x2D,0x24,0x24,0x00,0x00,0x07,0x04,0x04,0x04,0x1F,0x24,0x24,0x24,0x27,0x20,0x38,
0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0xFF,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0xFF,
0xFF,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x81,0x41,0x21,0x21,0x61,0x01,0x01,0x21,0xE1,0xE1,0x01,0xE1,0xE1,
0x21,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x21,0xE1,0x21,0x21,0x21,0x61,0x01,0x01,
0x21,0x21,0xE1,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0xC1,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x21,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0xFF,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x0F,0x10,0x20,0x24,0x1C,0x04,0x00,0x20,0x3F,0x01,0x3E,0x01,0x3F,
0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x3F,0x22,0x22,0x27,0x30,0x00,0x00,
0x20,0x20,0x3F,0x20,0x20,0x00,0x00,0x1E,0x25,0x25,0x25,0x16,0x00,0x00,0x1E,0x21,
0x21,0x21,0x13,0x00,0x01,0x01,0x1F,0x21,0x21,0x00,0x00,0x00,0x21,0x3F,0x22,0x21,
0x01,0x00,0x00,0x1E,0x21,0x21,0x21,0x1E,0x00,0x21,0x3F,0x22,0x01,0x01,0x3E,0x20,
0x00,0x21,0x21,0x3F,0x20,0x20,0x00,0x00,0x1E,0x21,0x21,0x21,0x13,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xF0,0x08,0x04,0x04,0x04,0x0C,0x00,0xF0,0x08,0x04,0x04,0x08,0xF0,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0xFC,0x04,0x00,
0x00,0x00,0x00,0x00,0x0C,0x04,0xFC,0x04,0x0C,0x00,0x04,0xFC,0x04,0x04,0x08,0xF0,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
0xFF,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x81,0x82,0x84,0x84,0x84,0x82,0x80,0x81,0x82,0x84,0x84,0x82,0x81,
0x80,0x80,0x86,0x86,0x80,0x80,0x80,0x80,0x80,0x85,0x83,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x84,0x87,0x84,0x84,
0x84,0x86,0x80,0x80,0x80,0x84,0x87,0x84,0x80,0x80,0x84,0x87,0x84,0x84,0x82,0x81,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,
0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0xFF
};

const unsigned char  *point;


/*************SPI配置函数*******************
SSD1306，SCL空闲时低电平，第一个上升沿采样
模拟SPI
******************************************/

/**************************SPI模块发送函数************************************************

 *************************************************************************/
void SPI_SendByte(unsigned char byte)
{
  
  unsigned char counter;
   
  for(counter=0;counter<8;counter++)
  { 
    SPI_SCK_0;
	  
    if((byte&0x80)==0)
    {
      SPI_SDA_0;
    }
    else SPI_SDA_1;
    byte=byte<<1;
	
    SPI_SCK_1;	
	
	SPI_SCK_0;
		
  } 
}

void OLED_send_cmd(unsigned char o_command)
  {
    SPI_DC_0;
    SPI_CS_0;
    SPI_SendByte(o_command);
    SPI_CS_1;
	 
    //SPI_DC_1;
  }
void OLED_send_data(unsigned char o_data)
  { 
    SPI_DC_1;
    SPI_CS_0;
    SPI_SendByte(o_data);
    SPI_CS_1;
	  
   }
void Column_set(unsigned char column)
  {
	column+=OLED_COLUMN_OFFSET;
    OLED_send_cmd(0x10|(column>>4));    //设置列地址高位
    OLED_send_cmd(0x00|(column&0x0f));   //设置列地址低位  
    	 
  }
void Page_set(unsigned char page)
  {
    OLED_send_cmd(0xb0+page);
  }
void OLED_clear(void)
  {
    unsigned char page,column;
    for(page=0;page<OLED_PAGE_NUMBER;page++)             //page loop
      { 
          Page_set(page);
          Column_set(0);	  
          for(column=0;column<OLED_COLUMN_NUMBER;column++)	//column loop
            {
              OLED_send_data(0x00);
            }
      }
  }
void OLED_full(void)
  {
    unsigned char page,column;
    for(page=0;page<OLED_PAGE_NUMBER;page++)             //page loop
      { 
        Page_set(page);
        Column_set(0);	  
	for(column=0;column<OLED_COLUMN_NUMBER;column++)	//column loop
          {
            OLED_send_data(0xff);
          }
      }
  }
void OLED_init(void)
  {
    unsigned char i;
    for(i=0;i<25;i++)
      {
        OLED_send_cmd(OLED_init_cmd[i]);
      }
  }

void Picture_display(const unsigned char *ptr_pic)
  {
    unsigned char page,column;
    for(page=0;page<(OLED_LINE_NUMBER/8);page++)        //page loop
      { 
	Page_set(page);
	Column_set(0);	  
	for(column=0;column<OLED_COLUMN_NUMBER;column++)	//column loop
          {
            OLED_send_data(*ptr_pic++);
          }
      }
  }
void Picture_ReverseDisplay(const unsigned char *ptr_pic)
{
    unsigned char page,column,data;
    for(page=0;page<(OLED_LINE_NUMBER/8);page++)        //page loop
      { 
	Page_set(page);
	Column_set(0);	  
	for(column=0;column<OLED_COLUMN_NUMBER;column++)	//column loop
          {
            data=*ptr_pic++;
            data=~data;
            OLED_send_data(data);
          }
      }
  }




int do_oled13_test(struct cmd_tbl *cmdtp, int flag, int argc, char *const argv[])
{
	printf("[%s][%d]\n", __func__, __LINE__);
	if(inited)
	{
		inited=0;
		// set func output
		*v_pa6_func &= ~((7 << 24) | (7 << 28));
		*v_pa6_func |=  ((1 << 24) | (1 << 28));

		*v_pa8_func &= ~((7 << 0) | (7 << 4) | (7 << 8));
		*v_pa8_func |=  ((1 << 0) | (1 << 4) | (1 << 8));

		// set drv
		*v_pa6_drv  &= ~((3 << (2*6)) | (3 << (2*7)) | (3 << (2*8)) | (3 << (2*9)) | (3 << (2*10)));
		*v_pa6_drv  |=  ((3 << (2*6)) | (3 << (2*7)) | (3 << (2*8)) | (3 << (2*9)) | (3 << (2*10)));
		
		// set pull
		*v_pa6_pull &= ~((3 << (2*6)) | (3 << (2*7)) | (3 << (2*8)) | (3 << (2*9)) | (3 << (2*10)));
		*v_pa6_pull |=  ((0 << (2*6)) | (0 << (2*7)) | (0 << (2*8)) | (0 << (2*9)) | (0 << (2*10)));
	}

	printk(KERN_ERR "[%s][%d][*v_pa6_func = 0x%x]\n", __func__, __LINE__, *v_pa6_func);
	printk(KERN_ERR "[%s][%d][*v_pa8_func = 0x%x]\n", __func__, __LINE__, *v_pa8_func);
	
	
	point= &picture_tab[0];

	SPI_SCK_0;
	SPI_RST_0;
	mdelay(1000);
	SPI_RST_1;
	mdelay(1000);
	OLED_init();
	OLED_full();
	mdelay(1000);
	OLED_clear();

	Picture_display(point);
	mdelay(1000);

	Picture_ReverseDisplay(point);
	mdelay(1000);


	return 0;
}


U_BOOT_CMD(
	oled13_test,	CONFIG_SYS_MAXARGS,	1,	do_oled13_test,
	"oled13_test",
	"oled13_test..............."
);

	 


int do_gpio_test(struct cmd_tbl *cmdtp, int flag, int argc, char *const argv[])
{
	printf("[%s][%d]\n", __func__, __LINE__);
	
	if(inited)
	{
		inited=0;
		// set func output
		*v_pa6_func &= ~((7 << 24) | (7 << 28));
		*v_pa6_func |=  ((1 << 24) | (1 << 28));

		*v_pa8_func &= ~((7 << 0) | (7 << 4) | (7 << 8));
		*v_pa8_func |=  ((1 << 0) | (1 << 4) | (1 << 8));

		// set drv
		*v_pa6_drv  &= ~((3 << (2*6)) | (3 << (2*7)) | (3 << (2*8)) | (3 << (2*9)) | (3 << (2*10)));
		*v_pa6_drv  |=  ((3 << (2*6)) | (3 << (2*7)) | (3 << (2*8)) | (3 << (2*9)) | (3 << (2*10)));
		
		// set pull
		*v_pa6_pull &= ~((3 << (2*6)) | (3 << (2*7)) | (3 << (2*8)) | (3 << (2*9)) | (3 << (2*10)));
		*v_pa6_pull |=  ((0 << (2*6)) | (0 << (2*7)) | (0 << (2*8)) | (0 << (2*9)) | (0 << (2*10)));
	}

	printk(KERN_ERR "[%s][%d][*v_pa6_func = 0x%x]\n", __func__, __LINE__, *v_pa6_func);
	printk(KERN_ERR "[%s][%d][*v_pa8_func = 0x%x]\n", __func__, __LINE__, *v_pa8_func);
	
	
	unsigned int index = 0;
	unsigned int level = 0;
	
	if(argc != 3)
	{
		printf("gpio_test <index> <level>\n");
		return -1;
	}
	
	index = simple_strtoul(argv[1], NULL, 16);
	level = simple_strtoul(argv[2], NULL, 16);
	
	
	switch(index)
	{
	case 1:
		OLED_CS(level);
		break;
	case 2:
		OLED_DC(level);
		break;
	case 3:
		OLED_RST(level);
		break;
	case 4:
		OLED_MOSI(level);
		break;
	case 5:
		OLED_CLK(level);
		break;
	default:
		break;
	}
	
	printk(KERN_ERR "[%s][%d][*v_pa6_data = 0x%x]\n", __func__, __LINE__, *v_pa6_data);
	
	return 0;
}


U_BOOT_CMD(
	gpio_test,	CONFIG_SYS_MAXARGS,	1,	do_gpio_test,
	"oled13_test",
	"oled13_test..............."
);
